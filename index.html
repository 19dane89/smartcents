<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SmartCents Budget Tracker with Documents Vault</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Poppins:wght@600;700&display=swap" rel="stylesheet" />
  <!-- FontAwesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- jsPDF & html2canvas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <!-- localForage for IndexedDB (document storage) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>

  <style>
    :root {
      --color-primary-bg: #f0f7ff;
      --color-primary-text: #0a3d62;
      --color-electric-indigo: #5a2a83;
      --color-emerald-green: #27ae60;
      --color-sunset-orange: #eb5757;
      --color-soft-purple: #8e44ad;
      --color-pastel-yellow: #f6e58d;

      --shadow-light: rgba(0, 0, 0, 0.12);
      --shadow-dark: rgba(90, 42, 131, 0.15);

      --glass-bg: rgba(255, 255, 255, 0.7);
      --glass-blur: 14px;

      --input-transition: 0.3s ease;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Inter', sans-serif;
      background: var(--color-primary-bg);
      color: var(--color-primary-text);
      overflow-x: hidden;
      background-image: url('https://images.unsplash.com/photo-1519389950473-47ba0277781c?auto=format&fit=crop&w=1470&q=80');
      background-size: cover;
      background-position: center;
      position: relative;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: rgba(255 255 255 / 0.8);
      backdrop-filter: blur(var(--glass-blur));
      -webkit-backdrop-filter: blur(var(--glass-blur));
      z-index: -1;
    }

    header {
      background: var(--glass-bg);
      backdrop-filter: blur(var(--glass-blur));
      padding: 1.5rem 3rem;
      text-align: center;
      box-shadow:
        4px 4px 10px var(--shadow-light),
        -4px -4px 10px #fff;
      border-radius: 0 0 30px 30px;
      user-select: none;
      position: sticky;
      top: 0;
      z-index: 20;
    }

    header h1 {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      font-weight: 700;
      font-size: 2.8rem;
      color: var(--color-electric-indigo);
      text-shadow: 0 2px 5px rgba(90, 42, 131, 0.35);
      display: inline-flex;
      align-items: center;
      gap: 0.6rem;
    }

    header p {
      margin: 0.4rem 0 0 0;
      font-weight: 600;
      font-style: italic;
      color: var(--color-soft-purple);
      font-size: 1.2rem;
      user-select: none;
    }

    /* Tabs */
    nav {
      display: flex;
      justify-content: center;
      gap: 1.5rem;
      background: var(--glass-bg);
      backdrop-filter: blur(var(--glass-blur));
      padding: 1rem 0;
      box-shadow:
        4px 4px 10px var(--shadow-light),
        -4px -4px 10px #fff;
      user-select: none;
      position: sticky;
      top: 88px; /* below header */
      z-index: 15;
    }

    nav button {
      background: transparent;
      border: none;
      font-weight: 600;
      font-family: 'Poppins', sans-serif;
      font-size: 1.3rem;
      color: var(--color-electric-indigo);
      cursor: pointer;
      padding: 0.5rem 1.5rem;
      border-radius: 24px;
      transition: background-color 0.3s ease;
      user-select: none;
    }

    nav button.active,
    nav button:hover {
      background: var(--color-electric-indigo);
      color: white;
      box-shadow: 0 6px 15px rgba(90, 42, 131, 0.6);
    }

    main {
      max-width: 1200px;
      margin: 2rem auto 4rem;
      padding: 0 1.5rem;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .glass-card {
      background: var(--glass-bg);
      border-radius: 25px;
      padding: 2rem 2.5rem;
      box-shadow:
        6px 6px 15px var(--shadow-light),
        -6px -6px 15px #ffffff;
      backdrop-filter: blur(var(--glass-blur));
      transition: transform 0.25s ease, box-shadow 0.25s ease;
      user-select: none;
      position: relative;
      overflow: hidden;
      margin-bottom: 2rem;
    }

    .glass-card:hover {
      transform: translateY(-8px);
      box-shadow:
        10px 10px 25px var(--shadow-dark),
        -10px -10px 25px #ffffffcc;
    }

    h2 {
      font-family: 'Poppins', sans-serif;
      font-weight: 700;
      font-size: 2rem;
      color: var(--color-electric-indigo);
      margin-bottom: 1rem;
      user-select: none;
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .divider {
      height: 4px;
      width: 60px;
      background: linear-gradient(90deg, var(--color-electric-indigo), var(--color-emerald-green));
      border-radius: 20px;
      margin-bottom: 1.5rem;
      animation: glow 2.5s ease-in-out infinite alternate;
    }

    @keyframes glow {
      0% {
        box-shadow: 0 0 8px var(--color-electric-indigo);
      }

      100% {
        box-shadow: 0 0 15px var(--color-emerald-green);
      }
    }

    label {
      font-weight: 600;
      display: block;
      margin-bottom: 0.3rem;
      color: var(--color-electric-indigo);
      user-select: none;
    }

    select,
    input[type="number"],
    input[type="file"] {
      font-family: 'Inter', sans-serif;
      font-weight: 600;
      font-size: 1rem;
      padding: 0.5rem 1rem;
      border-radius: 12px;
      border: 2px solid var(--color-electric-indigo);
      background: rgba(255 255 255 / 0.85);
      color: var(--color-electric-indigo);
      cursor: pointer;
      transition: background-color 0.3s ease, color 0.3s ease;
      margin-bottom: 1.5rem;
      user-select: none;
      width: 100%;
      box-sizing: border-box;
    }

    select:hover,
    select:focus,
    input[type="number"]:focus,
    input[type="file"]:focus {
      background-color: var(--color-electric-indigo);
      color: white;
      outline: none;
    }

    .grid-2cols {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 1.5rem;
      margin-bottom: 1rem;
    }

    .grid-3cols {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 1.2rem;
      margin-bottom: 1.5rem;
    }

    button {
      background-color: var(--color-electric-indigo);
      color: white;
      border: none;
      border-radius: 16px;
      padding: 0.9rem 2.5rem;
      font-weight: 700;
      font-size: 1.2rem;
      cursor: pointer;
      box-shadow: 0 6px 15px rgba(90, 42, 131, 0.6);
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
      user-select: none;
      margin-top: 1.8rem;
      display: block;
      width: fit-content;
    }

    button:hover {
      background-color: #401f66;
      box-shadow: 0 9px 25px rgba(64, 31, 102, 0.85);
    }

    #saveStatus {
      font-weight: 600;
      margin-top: 1rem;
      user-select: none;
    }

    #reportArea {
      margin-top: 2rem;
    }

    #reportArea h3 {
      color: var(--color-soft-purple);
    }

    #reportArea p {
      font-weight: 600;
      font-size: 1.1rem;
      color: var(--color-primary-text);
    }

    /* Smaller charts container */
    #chartsContainer {
      display: flex;
      flex-wrap: wrap;
      gap: 2rem;
      justify-content: center;
    }

    canvas {
      background: white;
      border-radius: 20px;
      box-shadow:
        4px 4px 12px var(--shadow-light),
        -4px -4px 12px #fff;
    }

    #savingsChart,
    #expensesChart {
      max-width: 450px;
      max-height: 280px;
      width: 100%;
      height: auto !important;
    }

    /* Report preview charts smaller */
    #reportSavingsChart,
    #reportExpensesChart {
      max-width: 480px;
      max-height: 280px;
      width: 100%;
      height: auto !important;
      margin-bottom: 1.5rem;
    }

    /* Documents Vault */
    #documentsVault .year-folder,
    #documentsVault .month-folder {
      margin-bottom: 1rem;
    }

    #documentsVault .year-folder > h3,
    #documentsVault .month-folder > h4 {
      color: var(--color-electric-indigo);
      cursor: pointer;
      user-select: none;
    }

    #documentsVault ul {
      list-style: none;
      padding-left: 1rem;
    }

    #documentsVault li {
      margin-bottom: 0.6rem;
      font-weight: 600;
      color: var(--color-emerald-green);
      cursor: pointer;
      user-select: none;
    }

    #documentsVault li:hover {
      text-decoration: underline;
    }

    /* Responsive tweaks */
    @media (max-width: 640px) {
      #chartsContainer {
        flex-direction: column;
        align-items: center;
      }
    }
  </style>
</head>

<body>
  <header>
    <h1><i class="fas fa-coins"></i> SmartCents Advanced</h1>
    <p>Personal Budget Tracker with Payslip Vault</p>
  </header>

  <nav role="tablist" aria-label="Main Navigation Tabs">
    <button role="tab" aria-selected="true" id="tabBudget" aria-controls="tabBudgetContent" class="active">Budget</button>
    <button role="tab" aria-selected="false" id="tabDocuments" aria-controls="tabDocumentsContent">Documents Vault</button>
  </nav>

  <main>
    <!-- Budget Tab -->
    <section id="tabBudgetContent" class="tab-content active" tabindex="0" role="tabpanel" aria-labelledby="tabBudget">
      <!-- Year & Month selectors -->
      <section class="glass-card" aria-label="Select Year and Month">
        <h2><i class="fas fa-calendar-alt"></i> Select Year & Month</h2>
        <div class="divider"></div>

        <label for="yearSelect">Year</label>
        <select id="yearSelect" aria-describedby="yearHelp" aria-label="Select year">
          <option value="2025" selected>2025</option>
          <option value="2026">2026</option>
          <option value="2027">2027</option>
          <option value="2028">2028</option>
          <option value="2029">2029</option>
        </select>

        <label for="monthSelect">Month</label>
        <select id="monthSelect" aria-label="Select month">
          <option value="0" selected>January</option>
          <option value="1">February</option>
          <option value="2">March</option>
          <option value="3">April</option>
          <option value="4">May</option>
          <option value="5">June</option>
          <option value="6">July</option>
          <option value="7">August</option>
          <option value="8">September</option>
          <option value="9">October</option>
          <option value="10">November</option>
          <option value="11">December</option>
        </select>

        <label for="reportTypeSelect">Report Type</label>
        <select id="reportTypeSelect" aria-label="Select report type">
          <option value="month" selected>Monthly</option>
          <option value="year">Yearly</option>
        </select>
      </section>

      <!-- Monthly inputs: Income, Expenses, Savings -->
      <section class="glass-card" aria-label="Monthly Income and Expenses">
        <h2><i class="fas fa-wallet"></i> Income, Expenses & Savings</h2>
        <div class="divider"></div>

        <label for="salaryInput"><i class="fas fa-money-bill-wave"></i> Net Salary</label>
        <input type="number" id="salaryInput" placeholder="Enter your monthly net salary" min="0" step="0.01" />

        <label for="savingsInput"><i class="fas fa-piggy-bank"></i> Savings</label>
        <input type="number" id="savingsInput" placeholder="Enter savings amount" min="0" step="0.01" />

        <h3><i class="fas fa-list-ul"></i> Expense Categories</h3>
        <div class="grid-3cols" id="expenseCategoriesContainer">
          <!-- Expense inputs dynamically added here -->
        </div>

        <!-- Upload payslip file -->
        <label for="payslipFile"><i class="fas fa-file-upload"></i> Upload Payslip PDF for selected month</label>
        <input type="file" id="payslipFile" accept="application/pdf" aria-describedby="payslipHelp" />

        <button id="saveDataBtn" aria-label="Save Income and Expense Data">Save Data</button>
        <div id="saveStatus" role="alert" aria-live="polite"></div>
      </section>

      <!-- Charts -->
      <section id="chartsContainer" aria-label="Financial charts overview" class="glass-card">
        <div>
          <h2><i class="fas fa-chart-line"></i> Savings Progress</h2>
          <canvas id="savingsChart" role="img" aria-label="Line chart showing savings progress"></canvas>
        </div>
        <div>
          <h2><i class="fas fa-chart-pie"></i> Expenses Breakdown</h2>
          <canvas id="expensesChart" role="img" aria-label="Pie chart showing expenses breakdown"></canvas>
        </div>
      </section>

      <!-- Report Area -->
      <section id="reportArea" class="glass-card" hidden aria-live="polite" aria-label="Generated financial report">
        <h3><i class="fas fa-file-alt"></i> Report Summary</h3>
        <p id="reportSummary"></p>
        <canvas id="reportSavingsChart" role="img" aria-label="Line chart for report savings"></canvas>
        <canvas id="reportExpensesChart" role="img" aria-label="Pie chart for report expenses"></canvas>

        <button id="generateReportBtn" aria-label="Generate PDF report">Generate PDF Report</button>
      </section>
    </section>

    <!-- Documents Vault Tab -->
    <section id="tabDocumentsContent" class="tab-content" tabindex="0" role="tabpanel" aria-labelledby="tabDocuments">
      <section class="glass-card" aria-label="Documents Vault">
        <h2><i class="fas fa-folder-open"></i> Documents Vault (Payslips)</h2>
        <div class="divider"></div>
        <p>View your uploaded payslips by year and month. Click to download.</p>
        <div id="documentsVault" aria-live="polite" aria-atomic="true">
          <!-- Documents folders will be loaded here -->
          <p>Loading documents...</p>
        </div>
      </section>
    </section>
  </main>

  <script>
    // Constants & global vars
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June',
      'July', 'August', 'September', 'October', 'November', 'December'];

    // Expense categories (example)
    const expenseCategories = [
      'Rent', 'Groceries', 'Utilities', 'Transport', 'Entertainment',
      'Health', 'Education', 'Clothing', 'Subscriptions', 'Misc'
    ];

    // Selectors
    const yearSelect = document.getElementById('yearSelect');
    const monthSelect = document.getElementById('monthSelect');
    const reportTypeSelect = document.getElementById('reportTypeSelect');
    const salaryInput = document.getElementById('salaryInput');
    const savingsInput = document.getElementById('savingsInput');
    const expenseCategoriesContainer = document.getElementById('expenseCategoriesContainer');
    const saveDataBtn = document.getElementById('saveDataBtn');
    const saveStatus = document.getElementById('saveStatus');
    const payslipFileInput = document.getElementById('payslipFile');

    const chartsContainer = document.getElementById('chartsContainer');
    const savingsChartCanvas = document.getElementById('savingsChart');
    const expensesChartCanvas = document.getElementById('expensesChart');

    const reportArea = document.getElementById('reportArea');
    const reportSummary = document.getElementById('reportSummary');
    const reportSavingsChartCanvas = document.getElementById('reportSavingsChart');
    const reportExpensesChartCanvas = document.getElementById('reportExpensesChart');
    const generateReportBtn = document.getElementById('generateReportBtn');

    // Tabs
    const tabBudgetBtn = document.getElementById('tabBudget');
    const tabDocumentsBtn = document.getElementById('tabDocuments');
    const tabBudgetContent = document.getElementById('tabBudgetContent');
    const tabDocumentsContent = document.getElementById('tabDocumentsContent');
    const documentsVault = document.getElementById('documentsVault');

    // State
    let currentYear = yearSelect.value;
    let currentMonth = parseInt(monthSelect.value);
    let reportType = reportTypeSelect.value;

    let yearData = null; // Array[12] for each month data object

    let savingsChart = null;
    let expensesChart = null;
    let reportSavingsChart = null;
    let reportExpensesChart = null;

    // Initialize storage for data
    const storageKey = year => `smartcents_data_${year}`;

    // -------------------------------
    // Initialize UI: create expense inputs
    function createExpenseInputs() {
      expenseCategoriesContainer.innerHTML = '';
      expenseCategories.forEach(cat => {
        const wrapper = document.createElement('div');
        wrapper.innerHTML = `
          <label for="expense_${cat}"><i class="fas fa-tag"></i> ${cat}</label>
          <input type="number" id="expense_${cat}" min="0" step="0.01" placeholder="0.00" aria-label="${cat} expense input" />
        `;
        expenseCategoriesContainer.appendChild(wrapper);
      });
    }

    // Load year data from localStorage or initialize
    function loadYearData(year) {
      const raw = localStorage.getItem(storageKey(year));
      if (raw) {
        try {
          const parsed = JSON.parse(raw);
          if (Array.isArray(parsed) && parsed.length === 12) {
            return parsed;
          }
        } catch { }
      }
      // Initialize empty year data
      const emptyYear = new Array(12).fill(null).map(() => ({
        salary: 0,
        expensesByCategory: expenseCategories.reduce((acc, cat) => { acc[cat] = 0; return acc; }, {}),
        savings: 0,
        payslipId: null, // will store unique ID of uploaded payslip (blob id)
      }));
      return emptyYear;
    }

    // Save year data
    function saveYearData(year, data) {
      localStorage.setItem(storageKey(year), JSON.stringify(data));
    }

    // Populate inputs for selected month
    function populateInputs() {
      if (!yearData) return;
      const monthData = yearData[currentMonth];
      if (!monthData) return;

      salaryInput.value = monthData.salary || 0;
      savingsInput.value = monthData.savings || 0;
      expenseCategories.forEach(cat => {
        const input = document.getElementById(`expense_${cat}`);
        input.value = monthData.expensesByCategory[cat] || 0;
      });

      // Clear file input
      payslipFileInput.value = '';

      saveStatus.textContent = '';
      hideReport();
    }

    // Calculate total expenses for given month data
    function calcTotalExpenses(monthData) {
      return Object.values(monthData.expensesByCategory).reduce((a, b) => a + b, 0);
    }

    // Update savings chart (line)
    function updateSavingsChart() {
      if (!yearData) return;
      const labels = monthNames;
      const data = yearData.map(m => m ? m.savings : 0);

      if (savingsChart) savingsChart.destroy();

      const ctx = savingsChartCanvas.getContext('2d');
      savingsChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Savings (ZAR)',
            data,
            borderColor: 'var(--color-emerald-green)',
            backgroundColor: 'rgba(39, 174, 96, 0.3)',
            fill: true,
            tension: 0.3,
            pointRadius: 6,
            pointHoverRadius: 8,
            borderWidth: 3,
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              labels: { color: 'var(--color-electric-indigo)', font: { weight: '600', size: 14 } }
            },
            tooltip: {
              enabled: true,
              callbacks: {
                label: ctx => `R${ctx.parsed.y.toFixed(2)}`
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { color: 'var(--color-electric-indigo)', font: { weight: '600' } }
            },
            x: {
              ticks: { color: 'var(--color-electric-indigo)', font: { weight: '600' } }
            }
          }
        }
      });
    }

    // Update expenses breakdown pie chart
    function updateExpensesChart() {
      if (!yearData) return;
      const monthData = yearData[currentMonth];
      if (!monthData) return;

      const labels = expenseCategories;
      const data = labels.map(cat => monthData.expensesByCategory[cat] || 0);

      if (expensesChart) expensesChart.destroy();

      const ctx = expensesChartCanvas.getContext('2d');
      expensesChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels,
          datasets: [{
            label: 'Expenses Breakdown',
            data,
            backgroundColor: [
              '#FF6384', '#36A2EB', '#FFCE56', '#8E44AD', '#27AE60',
              '#EB5757', '#F6E58D', '#2980B9', '#D35400', '#34495E'
            ]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'right', labels: { color: 'var(--color-electric-indigo)', font: { weight: '600' } } },
            tooltip: {
              enabled: true,
              callbacks: {
                label: ctx => `${ctx.label}: R${ctx.parsed.toFixed(2)}`
              }
            }
          }
        }
      });
    }

    // Save Data button handler
    saveDataBtn.addEventListener('click', () => {
      if (!yearData) return;
      // Get inputs
      const salary = parseFloat(salaryInput.value) || 0;
      const savings = parseFloat(savingsInput.value) || 0;

      // Expenses by category
      const expensesByCategory = {};
      expenseCategories.forEach(cat => {
        const val = parseFloat(document.getElementById(`expense_${cat}`).value);
        expensesByCategory[cat] = isNaN(val) ? 0 : val;
      });

      // Validate expenses vs salary+savings (optional)

      // Save month data
      yearData[currentMonth] = {
        salary,
        savings,
        expensesByCategory,
        payslipId: yearData[currentMonth] ? yearData[currentMonth].payslipId : null,
      };

      saveYearData(currentYear, yearData);

      // Refresh UI
      populateInputs();
      updateSavingsChart();
      updateExpensesChart();

      saveStatus.textContent = `Data saved for ${monthNames[currentMonth]} ${currentYear}`;
      saveStatus.style.color = 'var(--color-emerald-green)';
    });

    // Load year data and populate inputs
    function loadAndPopulateYear() {
      yearData = loadYearData(currentYear);
      populateInputs();
      updateSavingsChart();
      updateExpensesChart();
      saveStatus.textContent = '';
      hideReport();
    }

    // Tab switching
    tabBudgetBtn.addEventListener('click', () => {
      tabBudgetBtn.classList.add('active');
      tabDocumentsBtn.classList.remove('active');
      tabBudgetBtn.setAttribute('aria-selected', 'true');
      tabDocumentsBtn.setAttribute('aria-selected', 'false');
      tabBudgetContent.classList.add('active');
      tabDocumentsContent.classList.remove('active');
    });
    tabDocumentsBtn.addEventListener('click', () => {
      tabDocumentsBtn.classList.add('active');
      tabBudgetBtn.classList.remove('active');
      tabDocumentsBtn.setAttribute('aria-selected', 'true');
      tabBudgetBtn.setAttribute('aria-selected', 'false');
      tabDocumentsContent.classList.add('active');
      tabBudgetContent.classList.remove('active');
      loadDocumentsVault();
    });

    // Year & Month change handlers
    yearSelect.addEventListener('change', () => {
      currentYear = yearSelect.value;
      currentMonth = 0;
      monthSelect.value = 0;
      loadAndPopulateYear();
      hideReport();
    });

    monthSelect.addEventListener('change', () => {
      currentMonth = parseInt(monthSelect.value);
      populateInputs();
      updateSavingsChart();
      updateExpensesChart();
      saveStatus.textContent = '';
      hideReport();
    });

    reportTypeSelect.addEventListener('change', () => {
      reportType = reportTypeSelect.value;
      hideReport();
    });

    // Hide report
    function hideReport() {
      reportArea.hidden = true;
      if (reportSavingsChart) {
        reportSavingsChart.destroy();
        reportSavingsChart = null;
      }
      if (reportExpensesChart) {
        reportExpensesChart.destroy();
        reportExpensesChart = null;
      }
    }

    // Generate report button handler
    generateReportBtn.addEventListener('click', async () => {
      reportArea.hidden = false;

      let reportData = null;
      if (reportType === 'month') {
        // Monthly report
        reportData = [yearData[currentMonth]];
      } else {
        // Yearly report - all months
        reportData = yearData.filter(m => m !== null);
      }

      if (!reportData.length) {
        reportSummary.textContent = 'No data to generate report.';
        return;
      }

      // Aggregate data for report
      let salaryTotal = 0;
      let savingsTotal = 0;
      const aggregatedExpenses = expenseCategories.reduce((acc, cat) => {
        acc[cat] = 0;
        return acc;
      }, {});

      // Sum monthly data
      reportData.forEach(m => {
        if (!m) return;
        salaryTotal += m.salary || 0;
        savingsTotal += m.savings || 0;
        expenseCategories.forEach(cat => {
          aggregatedExpenses[cat] += m.expensesByCategory[cat] || 0;
        });
      });

      // Compose summary text
      const periodLabel = reportType === 'month'
        ? `${monthNames[currentMonth]} ${currentYear}`
        : `Year ${currentYear}`;

      const expensesTotal = Object.values(aggregatedExpenses).reduce((a, b) => a + b, 0);
      const balance = salaryTotal - expensesTotal - savingsTotal;

      reportSummary.innerHTML = `
        <strong>${periodLabel} Report</strong><br><br>
        Total Net Salary: R${salaryTotal.toFixed(2)}<br>
        Total Savings: R${savingsTotal.toFixed(2)}<br>
        Total Expenses: R${expensesTotal.toFixed(2)}<br>
        Balance (Salary - Expenses - Savings): R${balance.toFixed(2)}
      `;

      // Prepare charts data
      // Savings over months (for yearly) or single month for monthly report
      const savingsLabels = reportType === 'month' ? [monthNames[currentMonth]] : monthNames;
      const savingsValues = reportType === 'month' ? [yearData[currentMonth].savings || 0] : yearData.map(m => m ? m.savings : 0);

      // Expenses pie data
      const expenseLabels = expenseCategories;
      const expenseValues = Object.values(aggregatedExpenses);

      // Destroy previous charts if exist
      if (reportSavingsChart) reportSavingsChart.destroy();
      if (reportExpensesChart) reportExpensesChart.destroy();

      // Create savings line chart
      const ctxSavings = reportSavingsChartCanvas.getContext('2d');
      reportSavingsChart = new Chart(ctxSavings, {
        type: 'line',
        data: {
          labels: savingsLabels,
          datasets: [{
            label: 'Savings',
            data: savingsValues,
            borderColor: 'var(--color-emerald-green)',
            backgroundColor: 'rgba(39, 174, 96, 0.3)',
            fill: true,
            tension: 0.3,
            pointRadius: 6,
            pointHoverRadius: 8,
            borderWidth: 3,
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              labels: { color: 'var(--color-electric-indigo)', font: { weight: '600', size: 14 } }
            },
            tooltip: {
              enabled: true,
              callbacks: {
                label: ctx => `R${ctx.parsed.y.toFixed(2)}`
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { color: 'var(--color-electric-indigo)', font: { weight: '600' } }
            },
            x: {
              ticks: { color: 'var(--color-electric-indigo)', font: { weight: '600' } }
            }
          }
        }
      });

      // Create expenses pie chart
      const ctxExpenses = reportExpensesChartCanvas.getContext('2d');
      reportExpensesChart = new Chart(ctxExpenses, {
        type: 'pie',
        data: {
          labels: expenseLabels,
          datasets: [{
            label: 'Expenses Breakdown',
            data: expenseValues,
            backgroundColor: [
              '#FF6384', '#36A2EB', '#FFCE56', '#8E44AD', '#27AE60',
              '#EB5757', '#F6E58D', '#2980B9', '#D35400', '#34495E'
            ]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'right', labels: { color: 'var(--color-electric-indigo)', font: { weight: '600' } } },
            tooltip: {
              enabled: true,
              callbacks: {
                label: ctx => `${ctx.label}: R${ctx.parsed.toFixed(2)}`
              }
            }
          }
        }
      });
    });

    // PDF Generation with multipage support
    generateReportBtn.addEventListener('click', async () => {
      // Prevent multiple clicks
      generateReportBtn.disabled = true;
      generateReportBtn.textContent = "Generating PDF...";

      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'pt', 'a4');
      const pageWidth = pdf.internal.pageSize.getWidth();
      const margin = 40;

      // Title
      pdf.setFontSize(22);
      pdf.setTextColor(getComputedStyle(document.documentElement).getPropertyValue('--color-electric-indigo').trim());
      const title = `SmartCents Report - ${reportType === 'month' ? monthNames[currentMonth] + ' ' + currentYear : 'Year ' + currentYear}`;
      pdf.text(title, margin, 50);

      // Add summary text
      pdf.setFontSize(14);
      pdf.setTextColor('#333');
      const textLines = pdf.splitTextToSize(reportSummary.textContent, pageWidth - 2 * margin);
      pdf.text(textLines, margin, 90);

      // Convert charts to images with html2canvas
      // Savings chart
      await html2canvas(reportSavingsChartCanvas).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        let imgWidth = pageWidth - 2 * margin;
        let imgHeight = (canvas.height / canvas.width) * imgWidth;
        let yPos = 120;

        if (imgHeight + yPos > pdf.internal.pageSize.getHeight() - margin) {
          pdf.addPage();
          yPos = margin;
        }
        pdf.addImage(imgData, 'PNG', margin, yPos, imgWidth, imgHeight);
      });

      // Expenses chart
      await html2canvas(reportExpensesChartCanvas).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        let imgWidth = pageWidth - 2 * margin;
        let imgHeight = (canvas.height / canvas.width) * imgWidth;
        let yPos = pdf.internal.pageSize.getHeight() - imgHeight - margin;

        if (yPos < 140) {
          pdf.addPage();
          yPos = margin;
        }
        pdf.addImage(imgData, 'PNG', margin, yPos, imgWidth, imgHeight);
      });

      // Save PDF
      pdf.save(`SmartCents_Report_${currentYear}_${reportType}_${currentMonth}.pdf`);

      generateReportBtn.disabled = false;
      generateReportBtn.textContent = "Generate PDF Report";
    });

    // --- Payslip Document Vault Logic ---

    // Initialize localForage
    localforage.config({
      name: 'SmartCentsDocuments',
      storeName: 'payslips'
    });

    // Save payslip file on upload
    payslipFileInput.addEventListener('change', async e => {
      if (!yearData) return;
      const file = e.target.files[0];
      if (!file) return;

      if (file.type !== 'application/pdf') {
        alert('Only PDF files allowed.');
        payslipFileInput.value = '';
        return;
      }

      // Read file as blob
      const blob = file.slice();

      // Compose key: year-month e.g. "2025-0"
      const key = `${currentYear}-${currentMonth}`;

      try {
        await localforage.setItem(key, blob);
        // Update yearData payslipId for month
        yearData[currentMonth].payslipId = key;
        saveYearData(currentYear, yearData);

        alert(`Payslip uploaded for ${monthNames[currentMonth]} ${currentYear}`);
        payslipFileInput.value = '';

        // Refresh Documents Vault if active tab
        if (tabDocumentsContent.classList.contains('active')) {
          loadDocumentsVault();
        }
      } catch (err) {
        alert('Error saving file: ' + err);
      }
    });

    // Load and display Documents Vault
    async function loadDocumentsVault() {
      documentsVault.innerHTML = '';
      // Get all keys from localforage, which are year-month keys
      try {
        const keys = await localforage.keys();

        if (keys.length === 0) {
          documentsVault.innerHTML = '<p>No documents uploaded yet.</p>';
          return;
        }

        // Organize by year -> month
        const docsByYear = {};
        keys.forEach(key => {
          const [year, month] = key.split('-');
          if (!docsByYear[year]) docsByYear[year] = [];
          docsByYear[year].push(parseInt(month));
        });

        // Sort years desc
        const sortedYears = Object.keys(docsByYear).sort((a, b) => b - a);

        sortedYears.forEach(year => {
          const yearDiv = document.createElement('div');
          yearDiv.className = 'year-folder';

          const yHeader = document.createElement('h3');
          yHeader.textContent = year;
          yearDiv.appendChild(yHeader);

          const months = docsByYear[year].sort((a, b) => a - b);

          months.forEach(monthNum => {
            const monthDiv = document.createElement('div');
            monthDiv.className = 'month-folder';

            const mHeader = document.createElement('h4');
            mHeader.textContent = monthNames[monthNum];
            monthDiv.appendChild(mHeader);

            const fileList = document.createElement('ul');
            monthDiv.appendChild(fileList);

            const key = `${year}-${monthNum}`;
            // Add single payslip document for month
            const li = document.createElement('li');
            li.textContent = 'Payslip.pdf';
            li.setAttribute('role', 'button');
            li.tabIndex = 0;
            li.style.userSelect = 'none';

            li.addEventListener('click', () => {
              downloadPayslip(key);
            });

            li.addEventListener('keydown', e => {
              if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                downloadPayslip(key);
              }
            });

            fileList.appendChild(li);

            yearDiv.appendChild(monthDiv);
          });

          documentsVault.appendChild(yearDiv);
        });

      } catch (err) {
        documentsVault.innerHTML = '<p>Error loading documents.</p>';
        console.error(err);
      }
    }

    // Download payslip file
    async function downloadPayslip(key) {
      try {
        const blob = await localforage.getItem(key);
        if (!blob) {
          alert('Payslip not found.');
          return;
        }
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Payslip_${key.replace('-', '_')}.pdf`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (err) {
        alert('Error downloading file: ' + err);
      }
    }

    // Initialize expense inputs & load initial data
    createExpenseInputs();
    loadAndPopulateYear();

  </script>
</body>

</html>
