<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SmartCents Advanced Tracker</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=Poppins:wght@600;700&display=swap" rel="stylesheet" />
  <!-- FontAwesome for icons -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" rel="stylesheet" />

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <!-- jsPDF & html2canvas for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    :root {
      --color-primary-bg: #f0f7ff;
      --color-primary-text: #0a3d62;
      --color-electric-indigo: #5a2a83;
      --color-emerald-green: #27ae60;
      --color-sunset-orange: #eb5757;
      --color-soft-purple: #8e44ad;
      --color-pastel-yellow: #f6e58d;

      --shadow-light: rgba(0, 0, 0, 0.12);
      --shadow-dark: rgba(90, 42, 131, 0.15);

      --glass-bg: rgba(255, 255, 255, 0.7);
      --glass-blur: 14px;

      --input-transition: 0.3s ease;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Inter', sans-serif;
      background: var(--color-primary-bg);
      color: var(--color-primary-text);
      overflow-x: hidden;
      background-image: url('https://images.unsplash.com/photo-1519389950473-47ba0277781c?auto=format&fit=crop&w=1470&q=80');
      background-size: cover;
      background-position: center;
      position: relative;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      background: rgba(255 255 255 / 0.8);
      backdrop-filter: blur(var(--glass-blur));
      -webkit-backdrop-filter: blur(var(--glass-blur));
      z-index: -1;
    }

    header {
      background: var(--glass-bg);
      backdrop-filter: blur(var(--glass-blur));
      padding: 1.5rem 3rem;
      text-align: center;
      box-shadow:
        4px 4px 10px var(--shadow-light),
        -4px -4px 10px #fff;
      border-radius: 0 0 30px 30px;
      user-select: none;
      position: sticky;
      top: 0;
      z-index: 10;
    }

    header h1 {
      margin: 0;
      font-family: 'Poppins', sans-serif;
      font-weight: 700;
      font-size: 2.8rem;
      color: var(--color-electric-indigo);
      text-shadow: 0 2px 5px rgba(90, 42, 131, 0.35);
    }

    header p {
      margin: 0.4rem 0 0 0;
      font-weight: 600;
      font-style: italic;
      color: var(--color-soft-purple);
      font-size: 1.2rem;
      user-select: none;
    }

    main {
      max-width: 1200px;
      margin: 2rem auto 4rem;
      padding: 0 1.5rem;
      display: grid;
      grid-template-columns: 1fr;
      gap: 2.5rem;
    }

    .glass-card {
      background: var(--glass-bg);
      border-radius: 25px;
      padding: 2rem 2.5rem;
      box-shadow:
        6px 6px 15px var(--shadow-light),
        -6px -6px 15px #ffffff;
      backdrop-filter: blur(var(--glass-blur));
      transition: transform 0.25s ease, box-shadow 0.25s ease;
      user-select: none;
      position: relative;
      overflow: hidden;
    }

    .glass-card:hover {
      transform: translateY(-8px);
      box-shadow:
        10px 10px 25px var(--shadow-dark),
        -10px -10px 25px #ffffffcc;
    }

    h2 {
      font-family: 'Poppins', sans-serif;
      font-weight: 700;
      font-size: 2rem;
      color: var(--color-electric-indigo);
      margin-bottom: 1rem;
      user-select: none;
      display: flex;
      align-items: center;
      gap: 0.6rem;
    }

    .divider {
      height: 4px;
      width: 60px;
      background: linear-gradient(90deg, var(--color-electric-indigo), var(--color-emerald-green));
      border-radius: 20px;
      margin-bottom: 1.5rem;
      animation: glow 2.5s ease-in-out infinite alternate;
    }

    @keyframes glow {
      0% {
        box-shadow: 0 0 8px var(--color-electric-indigo);
      }

      100% {
        box-shadow: 0 0 15px var(--color-emerald-green);
      }
    }

    label {
      font-weight: 600;
      display: block;
      margin-bottom: 0.3rem;
      color: var(--color-electric-indigo);
      user-select: none;
    }

    select,
    input[type="number"] {
      font-family: 'Inter', sans-serif;
      font-weight: 600;
      font-size: 1rem;
      padding: 0.5rem 1rem;
      border-radius: 12px;
      border: 2px solid var(--color-electric-indigo);
      background: rgba(255 255 255 / 0.85);
      color: var(--color-electric-indigo);
      cursor: pointer;
      transition: background-color var(--input-transition), color var(--input-transition);
      margin-bottom: 1.5rem;
      user-select: none;
      width: 100%;
      box-sizing: border-box;
    }

    select:hover,
    select:focus,
    input[type="number"]:focus {
      background-color: var(--color-electric-indigo);
      color: white;
      outline: none;
    }

    .grid-2cols {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 1.5rem;
      margin-bottom: 1rem;
    }

    .grid-3cols {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 1.2rem;
      margin-bottom: 1.5rem;
    }

    button {
      background-color: var(--color-electric-indigo);
      color: white;
      border: none;
      border-radius: 16px;
      padding: 0.9rem 2.5rem;
      font-weight: 700;
      font-size: 1.2rem;
      cursor: pointer;
      box-shadow: 0 6px 15px rgba(90, 42, 131, 0.6);
      transition: background-color 0.3s ease, box-shadow 0.3s ease;
      user-select: none;
      margin-top: 1.8rem;
      display: block;
      width: fit-content;
    }

    button:hover {
      background-color: #401f66;
      box-shadow: 0 9px 25px rgba(64, 31, 102, 0.85);
    }

    #reportArea {
      margin-top: 2rem;
    }

    #reportArea h3 {
      color: var(--color-soft-purple);
    }

    #reportArea p {
      font-weight: 600;
      font-size: 1.1rem;
      color: var(--color-primary-text);
    }

    #result {
      margin-top: 1.5rem;
      font-weight: 700;
      font-size: 1.4rem;
      user-select: none;
    }

    #result.overspend {
      color: var(--color-sunset-orange);
    }

    #result.positive {
      color: var(--color-emerald-green);
    }

    /* Responsive tweaks */
    @media (max-width: 480px) {
      main {
        padding: 0 1rem;
      }

      h2 {
        font-size: 1.6rem;
      }

      button {
        width: 100%;
      }
    }
  </style>
</head>

<body>
  <header>
    <h1><i class="fas fa-coins"></i> SmartCents Advanced</h1>
    <p>Personal Budget, Savings & Passive Income Tracker</p>
  </header>

  <main>
    <!-- Year & Month selectors -->
    <section class="glass-card" aria-label="Select Year and Month">
      <h2><i class="fas fa-calendar-alt"></i> Select Year & Month</h2>
      <div class="divider"></div>

      <label for="yearSelect">Year</label>
      <select id="yearSelect" aria-describedby="yearHelp" aria-label="Select year">
        <option value="2025" selected>2025</option>
        <option value="2026">2026</option>
        <option value="2027">2027</option>
        <option value="2028">2028</option>
        <option value="2029">2029</option>
      </select>

      <label for="monthSelect">Month</label>
      <select id="monthSelect" aria-label="Select month">
        <option value="0" selected>January</option>
        <option value="1">February</option>
        <option value="2">March</option>
        <option value="3">April</option>
        <option value="4">May</option>
        <option value="5">June</option>
        <option value="6">July</option>
        <option value="7">August</option>
        <option value="8">September</option>
        <option value="9">October</option>
        <option value="10">November</option>
        <option value="11">December</option>
      </select>
    </section>

    <!-- Monthly inputs: Income, Expense categories, Passive income -->
    <section class="glass-card" aria-label="Monthly Income, Expenses, and Passive Income">
      <h2><i class="fas fa-wallet"></i> Income & Expenses</h2>
      <div class="divider"></div>

      <label for="salaryInput"><i class="fas fa-money-bill-wave"></i> Net Salary</label>
      <input type="number" id="salaryInput" placeholder="Enter your monthly net salary" min="0" step="0.01" />

      <h3><i class="fas fa-list-ul"></i> Expense Categories</h3>
      <div class="grid-3cols" id="expenseCategoriesContainer">
        <!-- Expense inputs dynamically added here -->
      </div>

      <h3><i class="fas fa-coins"></i> Passive Income Sources</h3>
      <div class="grid-2cols" id="passiveIncomeContainer">
        <!-- Passive income inputs dynamically added here -->
      </div>

      <button id="saveDataBtn"><i class="fas fa-save"></i> Save Monthly Data</button>
      <h3 id="saveStatus"></h3>
    </section>

    <!-- Charts: Savings progress, Expenses breakdown, Passive income -->
    <section class="glass-card" aria-label="Charts Overview">
      <h2><i class="fas fa-chart-line"></i> Charts Overview</h2>
      <div class="divider"></div>

      <canvas id="savingsChart" height="220" aria-label="Savings progress line chart" role="img"></canvas>

      <div style="margin-top: 2rem;">
        <canvas id="expensesChart" height="220" aria-label="Expenses breakdown pie chart" role="img"></canvas>
      </div>

      <div style="margin-top: 2rem;">
        <canvas id="passiveIncomeChart" height="220" aria-label="Passive income bar chart" role="img"></canvas>
      </div>
    </section>

    <!-- Report Generation -->
    <section class="glass-card" aria-label="Generate Report">
      <h2><i class="fas fa-file-pdf"></i> Generate Report</h2>
      <div class="divider"></div>

      <button id="generateReportBtn"><i class="fas fa-download"></i> Generate PDF Report</button>

      <div id="reportArea" hidden>
        <h3>Report Preview</h3>
        <p id="reportSummary"></p>
        <canvas id="reportSavingsChart" height="220" aria-label="Report savings chart" role="img"></canvas>
        <canvas id="reportExpensesChart" height="220" aria-label="Report expenses chart" role="img" style="margin-top:1.5rem;"></canvas>
        <canvas id="reportPassiveIncomeChart" height="220" aria-label="Report passive income chart" role="img" style="margin-top:1.5rem;"></canvas>
      </div>
    </section>
  </main>

  <script>
    // Expense categories list
    const expenseCategories = [
      'Rent',
      'Internet',
      'Cellphone',
      'Car',
      'Household',
      'Petrol',
      'Toiletries',
      'Pocket Money',
      'Entertainment',
      'Other'
    ];

    // Passive income sources list
    const passiveIncomeSources = [
      'Dividends',
      'Rental Income',
      'Freelancing',
      'Other'
    ];

    // LocalStorage keys helper
    const getStorageKey = (year) => `smartcents_data_${year}`;

    // Month names helper
    const monthNames = [
      'January', 'February', 'March', 'April', 'May', 'June',
      'July', 'August', 'September', 'October', 'November', 'December'
    ];

    // DOM elements
    const yearSelect = document.getElementById('yearSelect');
    const monthSelect = document.getElementById('monthSelect');
    const salaryInput = document.getElementById('salaryInput');
    const expenseCategoriesContainer = document.getElementById('expenseCategoriesContainer');
    const passiveIncomeContainer = document.getElementById('passiveIncomeContainer');
    const saveDataBtn = document.getElementById('saveDataBtn');
    const saveStatus = document.getElementById('saveStatus');
    const reportArea = document.getElementById('reportArea');
    const reportSummary = document.getElementById('reportSummary');
    const generateReportBtn = document.getElementById('generateReportBtn');

    // Charts
    let savingsChart, expensesChart, passiveIncomeChart;
    let reportSavingsChart, reportExpensesChart, reportPassiveIncomeChart;

    // Initialize app data
    let currentYear = yearSelect.value;
    let currentMonth = parseInt(monthSelect.value);

    // Initialize yearly data or load from localStorage
    function initYearData(year) {
      let stored = localStorage.getItem(getStorageKey(year));
      if (stored) return JSON.parse(stored);

      // Initialize 12 months with default empty data structure
      const emptyData = Array(12).fill(null).map(() => ({
        salary: 0,
        expensesByCategory: {},
        passiveIncomeBySource: {},
        savings: 0,
      }));

      // Fill expense categories and passive income with zeros
      for (let monthData of emptyData) {
        expenseCategories.forEach(cat => monthData.expensesByCategory[cat] = 0);
        passiveIncomeSources.forEach(src => monthData.passiveIncomeBySource[src] = 0);
      }

      localStorage.setItem(getStorageKey(year), JSON.stringify(emptyData));
      return emptyData;
    }

    // Save yearly data to localStorage
    function saveYearData(year, data) {
      localStorage.setItem(getStorageKey(year), JSON.stringify(data));
    }

    // Load current year's data
    let yearData = initYearData(currentYear);

    // Create expense inputs dynamically
    function createExpenseInputs() {
      expenseCategoriesContainer.innerHTML = '';
      for (const cat of expenseCategories) {
        const wrapper = document.createElement('div');
        wrapper.innerHTML = `
          <label for="expense_${cat}"><i class="fas fa-tag"></i> ${cat}</label>
          <input type="number" id="expense_${cat}" min="0" step="0.01" placeholder="R 0.00" />
        `;
        expenseCategoriesContainer.appendChild(wrapper);
      }
    }

    // Create passive income inputs dynamically
    function createPassiveIncomeInputs() {
      passiveIncomeContainer.innerHTML = '';
      for (const src of passiveIncomeSources) {
        const wrapper = document.createElement('div');
        wrapper.innerHTML = `
          <label for="passive_${src}"><i class="fas fa-coins"></i> ${src}</label>
          <input type="number" id="passive_${src}" min="0" step="0.01" placeholder="R 0.00" />
        `;
        passiveIncomeContainer.appendChild(wrapper);
      }
    }

    // Populate inputs from stored data for current month
    function populateInputs() {
      const monthData = yearData[currentMonth];
      salaryInput.value = monthData.salary || 0;

      expenseCategories.forEach(cat => {
        const input = document.getElementById(`expense_${cat}`);
        input.value = monthData.expensesByCategory[cat] || 0;
      });

      passiveIncomeSources.forEach(src => {
        const input = document.getElementById(`passive_${src}`);
        input.value = monthData.passiveIncomeBySource[src] || 0;
      });
    }

    // Calculate total expenses for current month
    function getTotalExpenses(monthIndex) {
      if (!yearData[monthIndex]) return 0;
      const expCats = yearData[monthIndex].expensesByCategory || {};
      return Object.values(expCats).reduce((a, b) => a + b, 0);
    }

    // Calculate total passive income for current month
    function getTotalPassiveIncome(monthIndex) {
      if (!yearData[monthIndex]) return 0;
      const passInc = yearData[monthIndex].passiveIncomeBySource || {};
      return Object.values(passInc).reduce((a, b) => a + b, 0);
    }

    // Update savings chart (line chart)
    function updateSavingsChart() {
      const labels = monthNames;
      const data = yearData.map(m => m ? m.savings : 0);

      if (savingsChart) savingsChart.destroy();

      const ctx = document.getElementById('savingsChart').getContext('2d');
      savingsChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Savings (ZAR)',
            data,
            borderColor: 'var(--color-emerald-green)',
            backgroundColor: 'rgba(39, 174, 96, 0.3)',
            fill: true,
            tension: 0.3,
            pointRadius: 6,
            pointHoverRadius: 8,
            hoverBackgroundColor: 'var(--color-emerald-green)',
            borderWidth: 3,
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              labels: { color: 'var(--color-electric-indigo)', font: { weight: '600', size: 14 } }
            },
            tooltip: {
              enabled: true,
              callbacks: {
                label: ctx => `R${ctx.parsed.y.toFixed(2)}`
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { color: 'var(--color-electric-indigo)', font: { weight: '600' } }
            },
            x: {
              ticks: { color: 'var(--color-electric-indigo)', font: { weight: '600' } }
            }
          }
        }
      });
    }

    // Update expenses breakdown chart (pie chart)
    function updateExpensesChart() {
      const monthData = yearData[currentMonth];
      if (!monthData) return;

      const labels = expenseCategories;
      const data = labels.map(cat => monthData.expensesByCategory[cat] || 0);

      if (expensesChart) expensesChart.destroy();

      const ctx = document.getElementById('expensesChart').getContext('2d');
      expensesChart = new Chart(ctx, {
        type: 'pie',
        data: {
          labels,
          datasets: [{
            label: 'Expenses Breakdown',
            data,
            backgroundColor: [
              '#FF6384', '#36A2EB', '#FFCE56', '#8E44AD', '#27AE60',
              '#EB5757', '#F6E58D', '#2980B9', '#D35400', '#34495E'
            ]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'right', labels: { color: 'var(--color-electric-indigo)', font: { weight: '600' } } },
            tooltip: {
              enabled: true,
              callbacks: {
                label: ctx => `${ctx.label}: R${ctx.parsed.toFixed(2)}`
              }
            }
          }
        }
      });
    }

    // Update passive income chart (bar chart)
    function updatePassiveIncomeChart() {
      const monthData = yearData[currentMonth];
      if (!monthData) return;

      const labels = passiveIncomeSources;
      const data = labels.map(src => monthData.passiveIncomeBySource[src] || 0);

      if (passiveIncomeChart) passiveIncomeChart.destroy();

      const ctx = document.getElementById('passiveIncomeChart').getContext('2d');
      passiveIncomeChart = new Chart(ctx, {
        type: 'bar',
        data: {
          labels,
          datasets: [{
            label: 'Passive Income',
            data,
            backgroundColor: 'var(--color-soft-purple)'
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { labels: { color: 'var(--color-electric-indigo)', font: { weight: '600' } } },
            tooltip: {
              enabled: true,
              callbacks: {
                label: ctx => `R${ctx.parsed.y.toFixed(2)}`
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: { color: 'var(--color-electric-indigo)', font: { weight: '600' } }
            },
            x: {
              ticks: { color: 'var(--color-electric-indigo)', font: { weight: '600' } }
            }
          }
        }
      });
    }

    // Populate inputs on year/month change or load
    function populateAllInputs() {
      populateInputs();
      updateSavingsChart();
      updateExpensesChart();
      updatePassiveIncomeChart();
      saveStatus.textContent = '';
      hideReport();
    }

    // Save data handler
    saveDataBtn.addEventListener('click', () => {
      // Read inputs
      const salary = parseFloat(salaryInput.value) || 0;

      // Expenses by category
      const expensesByCategory = {};
      expenseCategories.forEach(cat => {
        const val = parseFloat(document.getElementById(`expense_${cat}`).value);
        expensesByCategory[cat] = isNaN(val) ? 0 : val;
      });

      // Passive income by source
      const passiveIncomeBySource = {};
      passiveIncomeSources.forEach(src => {
        const val = parseFloat(document.getElementById(`passive_${src}`).value);
        passiveIncomeBySource[src] = isNaN(val) ? 0 : val;
      });

      // Calculate total expenses & savings
      const totalExpenses = Object.values(expensesByCategory).reduce((a, b) => a + b, 0);

      // Savings input is calculated as salary + passive income - expenses
      const totalPassiveIncome = Object.values(passiveIncomeBySource).reduce((a, b) => a + b, 0);
      const savings = salary + totalPassiveIncome - totalExpenses;

      // Save month data
      yearData[currentMonth] = {
        salary,
        expensesByCategory,
        passiveIncomeBySource,
        savings: savings >= 0 ? savings : 0, // Avoid negative savings
      };

      saveYearData(currentYear, yearData);
      populateAllInputs();

      saveStatus.textContent = `Data saved for ${monthNames[currentMonth]} ${currentYear}`;
      saveStatus.style.color = 'var(--color-emerald-green)';
    });

    // Hide report preview area
    function hideReport() {
      reportArea.hidden = true;
      if (reportSavingsChart) reportSavingsChart.destroy();
      if (reportExpensesChart) reportExpensesChart.destroy();
      if (reportPassiveIncomeChart) reportPassiveIncomeChart.destroy();
    }

    // Generate PDF report
    generateReportBtn.addEventListener('click', async () => {
      reportArea.hidden = false;

      const monthly = yearData[currentMonth];

      // Summary
      const salary = monthly.salary || 0;
      const expensesTotal = Object.values(monthly.expensesByCategory).reduce((a, b) => a + b, 0);
      const savings = monthly.savings || 0;
      const passiveIncomeTotal = Object.values(monthly.passiveIncomeBySource).reduce((a, b) => a + b, 0);
      const balance = salary + passiveIncomeTotal - expensesTotal;

      reportSummary.innerHTML = `
        <strong>${monthNames[currentMonth]} ${currentYear} Report</strong><br>
        <br>
        Income (Salary): R${salary.toFixed(2)}<br>
        Passive Income: R${passiveIncomeTotal.toFixed(2)}<br>
        Expenses Total: R${expensesTotal.toFixed(2)}<br>
        Savings: R${savings.toFixed(2)}<br>
        Balance: R${balance.toFixed(2)}
      `;

      // Prepare data for report charts - for all months in current year

      const labels = monthNames;

      // Savings data for all months
      const savingsData = yearData.map(m => m ? m.savings : 0);

      // Expenses aggregated by month (total)
      const expensesMonthly = yearData.map(m => {
        if (!m) return 0;
        return Object.values(m.expensesByCategory).reduce((a, b) => a + b, 0);
      });

      // Passive income aggregated by month
      const passiveIncomeMonthly = yearData.map(m => {
        if (!m) return 0;
        return Object.values(m.passiveIncomeBySource).reduce((a, b) => a + b, 0);
      });

      // Render report charts
      const ctxSavings = document.getElementById('reportSavingsChart').getContext('2d');
      if (reportSavingsChart) reportSavingsChart.destroy();
      reportSavingsChart = new Chart(ctxSavings, {
        type: 'line',
        data: {
          labels,
          datasets: [{
            label: 'Savings',
            data: savingsData,
            borderColor: 'var(--color-emerald-green)',
            backgroundColor: 'rgba(39, 174, 96, 0.3)',
            fill: true,
            tension: 0.3,
            pointRadius: 6,
            pointHoverRadius: 8,
            borderWidth: 3,
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              labels: { color: 'var(--color-electric-indigo)', font: { weight: '600', size: 14 } }
            },
            tooltip: {
              enabled: true,
              callbacks: {
                label: ctx => `R${ctx.parsed.y.toFixed(2)}`
              }
            }
          },
          scales: {
            y: { beginAtZero: true, ticks: { color: 'var(--color-electric-indigo)', font: { weight: '600' } } },
            x: { ticks: { color: 'var(--color-electric-indigo)', font: { weight: '600' } } }
          }
        }
      });

      // Expenses breakdown chart (aggregate for year)
      const aggregatedExpenses = {};
      expenseCategories.forEach(cat => aggregatedExpenses[cat] = 0);
      yearData.forEach(m => {
        if (m) {
          expenseCategories.forEach(cat => {
            aggregatedExpenses[cat] += m.expensesByCategory[cat] || 0;
          });
        }
      });

      const ctxExpenses = document.getElementById('reportExpensesChart').getContext('2d');
      if (reportExpensesChart) reportExpensesChart.destroy();
      reportExpensesChart = new Chart(ctxExpenses, {
        type: 'pie',
        data: {
          labels: expenseCategories,
          datasets: [{
            label: 'Expenses Breakdown (Year)',
            data: expenseCategories.map(cat => aggregatedExpenses[cat]),
            backgroundColor: [
              '#FF6384', '#36A2EB', '#FFCE56', '#8E44AD', '#27AE60',
              '#EB5757', '#F6E58D', '#2980B9', '#D35400', '#34495E'
            ]
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'right', labels: { color: 'var(--color-electric-indigo)', font: { weight: '600' } } },
            tooltip: {
              enabled: true,
              callbacks: {
                label: ctx => `${ctx.label}: R${ctx.parsed.toFixed(2)}`
              }
            }
          }
        }
      });

      // Passive income yearly bar chart (aggregated)
      const aggregatedPassiveIncome = {};
      passiveIncomeSources.forEach(src => aggregatedPassiveIncome[src] = 0);
      yearData.forEach(m => {
        if (m) {
          passiveIncomeSources.forEach(src => {
            aggregatedPassiveIncome[src] += m.passiveIncomeBySource[src] || 0;
          });
        }
      });

      const ctxPassive = document.getElementById('reportPassiveIncomeChart').getContext('2d');
      if (reportPassiveIncomeChart) reportPassiveIncomeChart.destroy();
      reportPassiveIncomeChart = new Chart(ctxPassive, {
        type: 'bar',
        data: {
          labels: passiveIncomeSources,
          datasets: [{
            label: 'Passive Income (Year)',
            data: passiveIncomeSources.map(src => aggregatedPassiveIncome[src]),
            backgroundColor: 'var(--color-soft-purple)'
          }]
        },
        options: {
          responsive: true,
          plugins: {
            legend: { labels: { color: 'var(--color-electric-indigo)', font: { weight: '600' } } },
            tooltip: {
              enabled: true,
              callbacks: {
                label: ctx => `R${ctx.parsed.y.toFixed(2)}`
              }
            }
          },
          scales: {
            y: { beginAtZero: true, ticks: { color: 'var(--color-electric-indigo)', font: { weight: '600' } } },
            x: { ticks: { color: 'var(--color-electric-indigo)', font: { weight: '600' } } }
          }
        }
      });

      // Generate PDF
      setTimeout(generatePDF, 400);
    });

    async function generatePDF() {
      const { jsPDF } = window.jspdf;

      // Capture report area with html2canvas
      const reportSection = document.getElementById('reportArea');
      const canvas = await html2canvas(reportSection, { scale: 2 });

      const imgData = canvas.toDataURL('image/png');

      const pdf = new jsPDF({
        orientation: 'portrait',
        unit: 'pt',
        format: 'a4'
      });

      const pageWidth = pdf.internal.pageSize.getWidth();
      const pageHeight = pdf.internal.pageSize.getHeight();

      pdf.setFontSize(22);
      pdf.setTextColor(getComputedStyle(document.documentElement).getPropertyValue('--color-electric-indigo').trim());
      pdf.text(`SmartCents Report - ${monthNames[currentMonth]} ${currentYear}`, pageWidth / 2, 40, { align: 'center' });

      const imgProps = pdf.getImageProperties(imgData);
      const imgWidth = pageWidth - 80;
      const imgHeight = (imgProps.height * imgWidth) / imgProps.width;

      pdf.addImage(imgData, 'PNG', 40, 60, imgWidth, imgHeight);

      pdf.save(`SmartCents_Report_${currentYear}_${currentMonth + 1}.pdf`);
    }

    // Update current year and month from selectors
    yearSelect.addEventListener('change', () => {
      currentYear = yearSelect.value;
      yearData = initYearData(currentYear);
      currentMonth = 0; // Reset to January on year change
      monthSelect.value = currentMonth;
      populateAllInputs();
      hideReport();
    });

    monthSelect.addEventListener('change', () => {
      currentMonth = parseInt(monthSelect.value);
      populateAllInputs();
      hideReport();
    });

    // Initial setup
    createExpenseInputs();
    createPassiveIncomeInputs();
    populateAllInputs();
  </script>
</body>

</html>
