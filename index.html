<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>SmartCents Dashboard</title>
  <link
    href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Poppins:wght@400;600&display=swap"
    rel="stylesheet"
  />
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.10.0/localforage.min.js"></script>
  <style>
    :root {
      --color-white: #ffffff;
      --color-light-blue: #d9ecff;
      --color-electric-indigo: #6f42c1;
      --color-emerald-green: #27ae60;
      --color-sunset-orange: #ff6f61;
      --color-soft-purple: #9b59b6;
      --color-pastel-yellow: #f9e79f;
      --shadow-neumorphic-light: 6px 6px 12px #c8d0e7, -6px -6px 12px #ffffff;
      --shadow-glass: rgba(255, 255, 255, 0.25) 0 8px 32px 0;
      --font-primary: 'Poppins', 'Inter', sans-serif;
    }

    body {
      font-family: var(--font-primary);
      margin: 0;
      background: linear-gradient(135deg, var(--color-light-blue), var(--color-white));
      color: #1b2a4e;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    header {
      background-color: var(--color-electric-indigo);
      color: var(--color-white);
      padding: 1rem 2rem;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
      font-weight: 600;
      font-size: 1.5rem;
    }

    main {
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1rem;
    }

    .glass-card {
      background: rgba(255, 255, 255, 0.6);
      box-shadow: var(--shadow-glass);
      border-radius: 16px;
      padding: 1.5rem 2rem;
      margin-bottom: 2rem;
      backdrop-filter: blur(10px);
      transition: box-shadow 0.3s ease;
    }

    .glass-card:hover {
      box-shadow: 0 10px 30px rgba(111, 66, 193, 0.3);
    }

    h2 {
      margin-top: 0;
      font-weight: 700;
      color: var(--color-electric-indigo);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    label {
      font-weight: 600;
      margin-bottom: 0.25rem;
      display: block;
      color: var(--color-electric-indigo);
    }

    input[type='number'],
    input[type='file'],
    select {
      width: 100%;
      padding: 0.6rem 0.8rem;
      margin-bottom: 1rem;
      border-radius: 10px;
      border: 1.5px solid #ccc;
      font-size: 1rem;
      font-family: var(--font-primary);
      box-shadow: var(--shadow-neumorphic-light);
      transition: border-color 0.3s ease;
    }

    input[type='number']:focus,
    input[type='file']:focus,
    select:focus {
      border-color: var(--color-electric-indigo);
      outline: none;
    }

    button {
      background-color: var(--color-electric-indigo);
      color: var(--color-white);
      padding: 0.8rem 1.6rem;
      border: none;
      border-radius: 12px;
      font-size: 1rem;
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.3s ease;
      box-shadow: var(--shadow-neumorphic-light);
    }

    button:hover:not(:disabled) {
      background-color: #59319f;
    }

    button:disabled {
      background-color: #bbb;
      cursor: not-allowed;
    }

    /* Expense inputs grid */
    #expenseCategoriesContainer {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
      gap: 1rem 2rem;
      align-items: flex-start;
    }

    #expenseCategoriesContainer > div {
      display: flex;
      flex-direction: column;
    }

    /* Charts container smaller & side-by-side */
    #chartsContainer {
      display: flex;
      gap: 2rem;
      flex-wrap: wrap;
      justify-content: center;
    }

    #chartsContainer > div {
      flex: 1 1 300px;
      max-width: 500px;
    }

    canvas {
      width: 100% !important;
      height: 280px !important;
      border-radius: 12px;
      box-shadow: var(--shadow-neumorphic-light);
      background: var(--color-white);
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .tabs button {
      background: var(--color-light-blue);
      border-radius: 10px;
      padding: 0.6rem 1.2rem;
      border: 1.5px solid var(--color-electric-indigo);
      font-weight: 600;
      color: var(--color-electric-indigo);
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .tabs button.active,
    .tabs button:hover {
      background-color: var(--color-electric-indigo);
      color: var(--color-white);
      box-shadow: 0 8px 20px rgba(111, 66, 193, 0.3);
    }

    .tab-content {
      display: none;
      outline: none;
    }

    .tab-content.active {
      display: block;
    }

    /* Documents vault */
    #documentsVault {
      max-height: 350px;
      overflow-y: auto;
      border: 1px solid #ddd;
      padding: 1rem;
      border-radius: 12px;
      background: var(--color-white);
    }

    .year-folder > h3 {
      margin-bottom: 0.5rem;
      color: var(--color-electric-indigo);
      cursor: default;
    }

    .month-folder {
      margin-left: 1rem;
      margin-bottom: 1rem;
    }

    .month-folder > h4 {
      margin-bottom: 0.3rem;
      font-weight: 600;
      color: var(--color-emerald-green);
    }

    ul {
      list-style: none;
      padding-left: 1rem;
      margin: 0;
    }

    ul li {
      cursor: pointer;
      color: var(--color-electric-indigo);
      text-decoration: underline;
      margin-bottom: 0.3rem;
      user-select: none;
    }

    ul li:hover,
    ul li:focus {
      color: var(--color-sunset-orange);
      outline: none;
    }

    /* Divider */
    .divider {
      border-bottom: 1px solid #ccc;
      margin: 0.75rem 0 1.25rem 0;
    }
  </style>
</head>

<body>
  <header>
    <h1>SmartCents</h1>
    <span>Personal Budget &amp; Savings Tracker</span>
  </header>

  <main>
    <!-- Tabs -->
    <nav class="tabs" role="tablist" aria-label="Main tabs">
      <button id="tabBudget" role="tab" aria-selected="true" aria-controls="tabBudgetContent" tabindex="0" class="active">Budget</button>
      <button id="tabDocuments" role="tab" aria-selected="false" aria-controls="tabDocumentsContent" tabindex="-1">Documents Vault</button>
    </nav>

    <!-- Budget Tab -->
    <section id="tabBudgetContent" class="tab-content active" role="tabpanel" aria-labelledby="tabBudget" tabindex="0">
      <section class="glass-card" aria-label="Income and Expenses Input">
        <h2>Income &amp; Expenses</h2>

        <label for="yearSelect">Select Year</label>
        <select id="yearSelect" aria-label="Select year">
          <!-- Years populated by script -->
        </select>

        <label for="monthSelect">Select Month</label>
        <select id="monthSelect" aria-label="Select month">
          <!-- Months populated by script -->
        </select>

        <label for="salaryInput">Net Salary</label>
        <input type="number" id="salaryInput" min="0" step="0.01" placeholder="Enter your monthly net salary" aria-describedby="salaryHelp" />

        <label for="savingsInput">Savings</label>
        <input type="number" id="savingsInput" min="0" step="0.01" placeholder="Enter savings amount for the month" aria-describedby="savingsHelp" />

        <div id="expenseCategoriesContainer" aria-label="Expenses categories input">
          <!-- Expense inputs added dynamically -->
        </div>

        <label for="payslipFile">Upload Payslip PDF for selected month</label>
        <input type="file" id="payslipFile" accept="application/pdf" aria-describedby="payslipHelp" />

        <button id="saveDataBtn" aria-label="Save Income and Expense Data">Save Data</button>
        <div id="saveStatus" role="alert" aria-live="polite"></div>
      </section>

      <!-- Charts -->
      <section id="chartsContainer" aria-label="Financial charts overview" class="glass-card">
        <div>
          <h2><i class="fas fa-chart-line"></i> Savings Progress</h2>
          <canvas id="savingsChart" role="img" aria-label="Line chart showing savings progress"></canvas>
        </div>
        <div>
          <h2><i class="fas fa-chart-pie"></i> Expenses Breakdown</h2>
          <canvas id="expensesChart" role="img" aria-label="Pie chart showing expenses breakdown"></canvas>
        </div>
      </section>

      <!-- Report Options -->
      <section id="reportOptions" class="glass-card" aria-label="Report options">
        <label for="reportTypeSelect">Select Report Type:</label>
        <select id="reportTypeSelect" aria-label="Select report type">
          <option value="month">Monthly</option>
          <option value="year">Yearly</option>
        </select>

        <button id="showReportBtn" aria-label="Show Report">Show Report</button>
      </section>

      <!-- Report Area -->
      <section id="reportArea" class="glass-card" hidden aria-live="polite" aria-label="Generated financial report">
        <h3><i class="fas fa-file-alt"></i> Report Summary</h3>
        <p id="reportSummary"></p>
        <canvas id="reportSavingsChart" role="img" aria-label="Line chart for report savings"></canvas>
        <canvas id="reportExpensesChart" role="img" aria-label="Pie chart for report expenses"></canvas>

        <button id="generateReportBtn" aria-label="Generate PDF report">Generate PDF Report</button>
      </section>
    </section>

    <!-- Documents Vault Tab -->
    <section id="tabDocumentsContent" class="tab-content" tabindex="0" role="tabpanel" aria-labelledby="tabDocuments">
      <section class="glass-card" aria-label="Documents Vault">
        <h2><i class="fas fa-folder-open"></i> Documents Vault (Payslips)</h2>
        <div class="divider"></div>
        <p>View your uploaded payslips by year and month. Click to download.</p>
        <div id="documentsVault" aria-live="polite" aria-atomic="true">
          <!-- Documents folders will be loaded here -->
          <p>Loading documents...</p>
        </div>
      </section>
    </section>
  </main>

  <script>
    // Constants & global vars
    const monthNames = [
      'January', 'February', 'March', 'April', 'May', 'June',
      'July', 'August', 'September', 'October', 'November', 'December'
    ];

    // Expense categories without 'Education'
    const expenseCategories = [
      'Rent', 'Groceries', 'Utilities', 'Transport', 'Entertainment',
      'Health', 'Clothing', 'Subscriptions', 'Misc'
    ];

    // Selectors
    const yearSelect = document.getElementById('yearSelect');
    const monthSelect = document.getElementById('monthSelect');
    const reportTypeSelect = document.getElementById('reportTypeSelect');
    const salaryInput = document.getElementById('salaryInput');
    const savingsInput = document.getElementById('savingsInput');
    const expenseCategoriesContainer = document.getElementById('expenseCategoriesContainer');
    const saveDataBtn = document.getElementById('saveDataBtn');
    const saveStatus = document.getElementById('saveStatus');
    const payslipFileInput = document.getElementById('payslipFile');

    const chartsContainer = document.getElementById('chartsContainer');
    const savingsChartCanvas = document.getElementById('savingsChart');
    const expensesChartCanvas = document.getElementById('expensesChart');

    const reportOptions = document.getElementById('reportOptions');
    const showReportBtn = document.getElementById('showReportBtn');
    const reportArea = document.getElementById('reportArea');
    const reportSummary = document.getElementById('reportSummary');
    const reportSavingsChartCanvas = document.getElementById('reportSavingsChart');
    const reportExpensesChartCanvas = document.getElementById('reportExpensesChart');
    const generateReportBtn = document.getElementById('generateReportBtn');

    // Tabs
    const tabBudgetBtn = document.getElementById('tabBudget');
    const tabDocumentsBtn = document.getElementById('tabDocuments');
    const tabBudgetContent = document.getElementById('tabBudgetContent');
    const tabDocumentsContent = document.getElementById('tabDocumentsContent');
    const documentsVault = document.getElementById('documentsVault');

    // State
    let currentYear = new Date().getFullYear().toString();
    let currentMonth = new Date().getMonth();
    let reportType = 'month';

    // Data storage (localStorage keys)
    // We'll store yearly data in localStorage as JSON keyed by year, each year's data is an array[12] of months objects
    // Each month object: { salary, savings, expenses: { category: value }, payslipId? }
    function getYearKey(year) {
      return `smartcents_data_${year}`;
    }

    // Initialize years and months dropdown
    function initYearMonthSelectors() {
      // Populate years from currentYear - 5 to currentYear + 5 for flexibility
      const startYear = currentYear - 5;
      const endYear = currentYear + 5;
      for (let y = startYear; y <= endYear; y++) {
        const option = document.createElement('option');
        option.value = y.toString();
        option.textContent = y.toString();
        if (y.toString() === currentYear) option.selected = true;
        yearSelect.appendChild(option);
      }
      // Months options
      monthNames.forEach((m, i) => {
        const option = document.createElement('option');
        option.value = i.toString();
        option.textContent = m;
        if (i === currentMonth) option.selected = true;
        monthSelect.appendChild(option);
      });
    }

    // Initialize expense inputs dynamically
    function createExpenseInputs() {
      expenseCategoriesContainer.innerHTML = '';
      expenseCategories.forEach(category => {
        const div = document.createElement('div');
        div.classList.add('expense-category');

        const label = document.createElement('label');
        label.setAttribute('for', `expense-${category.toLowerCase()}`);
        label.textContent = category;

        const input = document.createElement('input');
        input.type = 'number';
        input.min = '0';
        input.step = '0.01';
        input.id = `expense-${category.toLowerCase()}`;
        input.classList.add('expense-input');
        input.placeholder = `Enter ${category} expense`;

        div.appendChild(label);
        div.appendChild(input);
        expenseCategoriesContainer.appendChild(div);
      });
    }

    // Load yearly data from localStorage
    function loadYearData(year) {
      const stored = localStorage.getItem(getYearKey(year));
      if (!stored) return new Array(12).fill(null);
      try {
        const parsed = JSON.parse(stored);
        // Ensure length 12
        if (parsed.length !== 12) return new Array(12).fill(null);
        return parsed;
      } catch {
        return new Array(12).fill(null);
      }
    }

    // Save yearly data to localStorage
    function saveYearData(year, data) {
      localStorage.setItem(getYearKey(year), JSON.stringify(data));
    }

    // Current year data in memory
    let yearData = loadYearData(currentYear);

    // Load inputs for current month/year
    function populateInputs() {
      if (!yearData[currentMonth]) {
        // Initialize empty month data object
        yearData[currentMonth] = {
          salary: 0,
          savings: 0,
          expenses: {}
        };
        expenseCategories.forEach(c => yearData[currentMonth].expenses[c] = 0);
      }

      const monthData = yearData[currentMonth];
      salaryInput.value = monthData.salary || 0;
      savingsInput.value = monthData.savings || 0;
      expenseCategories.forEach(category => {
        const val = monthData.expenses[category] || 0;
        const input = document.getElementById(`expense-${category.toLowerCase()}`);
        if (input) input.value = val;
      });

      // Clear payslip input for upload - no file selection persists for security reasons
      payslipFileInput.value = '';
    }

    // Save inputs into yearData and localStorage
    function saveInputs() {
      if (!yearData[currentMonth]) {
        yearData[currentMonth] = {
          salary: 0,
          savings: 0,
          expenses: {}
        };
      }

      yearData[currentMonth].salary = parseFloat(salaryInput.value) || 0;
      yearData[currentMonth].savings = parseFloat(savingsInput.value) || 0;

      expenseCategories.forEach(category => {
        const input = document.getElementById(`expense-${category.toLowerCase()}`);
        if (input) {
          yearData[currentMonth].expenses[category] = parseFloat(input.value) || 0;
        }
      });

      saveYearData(currentYear, yearData);
      saveStatus.textContent = `Data saved for ${monthNames[currentMonth]} ${currentYear}`;
      setTimeout(() => {
        saveStatus.textContent = '';
      }, 3000);

      updateCharts();
    }

    // Update year and month on selectors change
    yearSelect.addEventListener('change', () => {
      currentYear = yearSelect.value;
      yearData = loadYearData(currentYear);
      populateInputs();
      updateCharts();
      loadDocumentsVault();
      reportArea.hidden = true;
    });

    monthSelect.addEventListener('change', () => {
      currentMonth = parseInt(monthSelect.value, 10);
      populateInputs();
      updateCharts();
      loadDocumentsVault();
      reportArea.hidden = true;
    });

    saveDataBtn.addEventListener('click', saveInputs);

    // Payslip upload handling with localForage IndexedDB
    localforage.config({
      name: 'SmartCentsDocuments',
      storeName: 'payslips'
    });

    payslipFileInput.addEventListener('change', async e => {
      const file = e.target.files[0];
      if (!file) return;
      if (file.type !== 'application/pdf') {
        alert('Only PDF files allowed.');
        payslipFileInput.value = '';
        return;
      }
      try {
        const blob = file.slice();
        const key = `${currentYear}-${currentMonth}`;
        await localforage.setItem(key, blob);

        // Save payslipId reference in yearData
        if (!yearData[currentMonth]) yearData[currentMonth] = {};
        yearData[currentMonth].payslipId = key;
        saveYearData(currentYear, yearData);

        alert(`Payslip uploaded for ${monthNames[currentMonth]} ${currentYear}`);
        payslipFileInput.value = '';
        loadDocumentsVault();
      } catch (err) {
        alert('Error saving payslip: ' + err);
      }
    });

    // Load and display payslips in Documents Vault
    async function loadDocumentsVault() {
      documentsVault.innerHTML = '<p>Loading documents...</p>';
      try {
        const keys = await localforage.keys();
        if (keys.length === 0) {
          documentsVault.innerHTML = '<p>No documents uploaded yet.</p>';
          return;
        }
        // Organize by year -> months
        const docsByYear = {};
        keys.forEach(key => {
          const [year, month] = key.split('-');
          if (!docsByYear[year]) docsByYear[year] = [];
          docsByYear[year].push(parseInt(month));
        });

        documentsVault.innerHTML = '';
        const sortedYears = Object.keys(docsByYear).sort((a, b) => b - a);

        sortedYears.forEach(year => {
          const yearDiv = document.createElement('div');
          yearDiv.className = 'year-folder';

          const yHeader = document.createElement('h3');
          yHeader.textContent = year;
          yearDiv.appendChild(yHeader);

          const months = docsByYear[year].sort((a, b) => a - b);

          months.forEach(monthNum => {
            const monthDiv = document.createElement('div');
            monthDiv.className = 'month-folder';

            const mHeader = document.createElement('h4');
            mHeader.textContent = monthNames[monthNum];
            monthDiv.appendChild(mHeader);

            const fileList = document.createElement('ul');
            monthDiv.appendChild(fileList);

            const key = `${year}-${monthNum}`;
            const li = document.createElement('li');
            li.textContent = 'Payslip.pdf';
            li.setAttribute('role', 'button');
            li.tabIndex = 0;
            li.style.userSelect = 'none';

            li.addEventListener('click', () => {
              downloadPayslip(key);
            });
            li.addEventListener('keydown', e => {
              if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                downloadPayslip(key);
              }
            });

            fileList.appendChild(li);
            yearDiv.appendChild(monthDiv);
          });

          documentsVault.appendChild(yearDiv);
        });
      } catch (err) {
        documentsVault.innerHTML = '<p>Error loading documents.</p>';
        console.error(err);
      }
    }

    async function downloadPayslip(key) {
      try {
        const blob = await localforage.getItem(key);
        if (!blob) {
          alert('Payslip not found.');
          return;
        }
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `Payslip_${key.replace('-', '_')}.pdf`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(url);
      } catch (err) {
        alert('Error downloading payslip: ' + err);
      }
    }

    // Chart instances
    let savingsChart = null;
    let expensesChart = null;

    // Update charts with current year data
    function updateCharts() {
      if (!yearData) return;

      // Savings line chart data - 12 months
      const savingsData = yearData.map(m => (m ? m.savings || 0 : 0));
      const monthsLabels = monthNames;

      if (savingsChart) savingsChart.destroy();
      savingsChart = new Chart(savingsChartCanvas.getContext('2d'), {
        type: 'line',
        data: {
          labels: monthsLabels,
          datasets: [
            {
              label: 'Savings (R)',
              data: savingsData,
              fill: true,
              backgroundColor: 'rgba(39, 174, 96, 0.2)', // Emerald green translucent
              borderColor: 'rgba(39, 174, 96, 1)',
              tension: 0.3,
              pointRadius: 5,
              pointHoverRadius: 7,
              hoverBackgroundColor: 'rgba(39, 174, 96, 0.5)',
              borderWidth: 3,
            },
          ],
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true },
            tooltip: {
              enabled: true,
              mode: 'nearest',
              intersect: false,
              callbacks: {
                label: ctx => `R ${ctx.parsed.y.toFixed(2)}`,
              },
            },
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: val => `R${val}`,
              },
            },
          },
        },
      });

      // Expenses pie chart for current month
      const monthData = yearData[currentMonth];
      const expenseData = expenseCategories.map(
        cat => (monthData && monthData.expenses && monthData.expenses[cat]) || 0
      );

      if (expensesChart) expensesChart.destroy();
      expensesChart = new Chart(expensesChartCanvas.getContext('2d'), {
        type: 'pie',
        data: {
          labels: expenseCategories,
          datasets: [
            {
              data: expenseData,
              backgroundColor: [
                '#FF6F61', // Sunset Orange
                '#6F42C1', // Electric Indigo
                '#F9E79F', // Pastel Yellow
                '#9B59B6', // Soft Purple
                '#27AE60', // Emerald Green
                '#FF9F1C',
                '#00B4D8',
                '#E36414',
                '#7E57C2',
              ],
            },
          ],
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' },
            tooltip: {
              enabled: true,
              callbacks: {
                label: ctx => `${ctx.label}: R ${ctx.parsed.toFixed(2)}`,
              },
            },
          },
        },
      });
    }

    // Report generation
    showReportBtn.addEventListener('click', () => {
      reportType = reportTypeSelect.value;
      reportArea.hidden = false;

      if (reportType === 'month') {
        generateMonthlyReport();
      } else {
        generateYearlyReport();
      }
    });

    generateReportBtn.addEventListener('click', async () => {
      generateReportBtn.disabled = true;
      generateReportBtn.textContent = 'Generating PDF...';

      try {
        await generatePDFReport();
      } catch (err) {
        alert('Error generating PDF: ' + err);
      }

      generateReportBtn.disabled = false;
      generateReportBtn.textContent = 'Generate PDF Report';
    });

    // Helpers to generate reports
    function generateMonthlyReport() {
      const monthData = yearData[currentMonth];
      if (!monthData) {
        reportSummary.textContent = 'No data available for this month.';
        clearReportCharts();
        return;
      }

      // Summary text
      const totalExpenses = expenseCategories.reduce(
        (sum, c) => sum + (monthData.expenses[c] || 0),
        0
      );
      const balance = (monthData.salary || 0) - totalExpenses - (monthData.savings || 0);

      reportSummary.textContent = `
        Month: ${monthNames[currentMonth]} ${currentYear}
        Net Salary: R${(monthData.salary || 0).toFixed(2)}
        Total Expenses: R${totalExpenses.toFixed(2)}
        Savings: R${(monthData.savings || 0).toFixed(2)}
        Balance (Salary - Expenses - Savings): R${balance.toFixed(2)}
      `;

      // Update charts
      updateReportSavingsChart([monthData.savings || 0]);
      updateReportExpensesChart(monthData.expenses);
    }

    function generateYearlyReport() {
      // Aggregate over all months
      let totalSalary = 0;
      let totalSavings = 0;
      const totalExpenses = {};
      expenseCategories.forEach(c => (totalExpenses[c] = 0));

      let monthsWithData = 0;
      yearData.forEach(monthData => {
        if (monthData) {
          monthsWithData++;
          totalSalary += monthData.salary || 0;
          totalSavings += monthData.savings || 0;
          expenseCategories.forEach(c => {
            totalExpenses[c] += monthData.expenses[c] || 0;
          });
        }
      });

      if (monthsWithData === 0) {
        reportSummary.textContent = 'No data available for this year.';
        clearReportCharts();
        return;
      }

      const balance = totalSalary - Object.values(totalExpenses).reduce((a, b) => a + b, 0) - totalSavings;

      reportSummary.textContent = `
        Year: ${currentYear}
        Total Net Salary: R${totalSalary.toFixed(2)}
        Total Expenses: R${Object.values(totalExpenses).reduce((a, b) => a + b, 0).toFixed(2)}
        Total Savings: R${totalSavings.toFixed(2)}
        Balance (Salary - Expenses - Savings): R${balance.toFixed(2)}
      `;

      // For yearly savings chart, show savings per month
      const savingsData = yearData.map(m => (m ? m.savings || 0 : 0));
      updateReportSavingsChart(savingsData);

      updateReportExpensesChart(totalExpenses);
    }

    // Update report savings chart
    let reportSavingsChart = null;
    function updateReportSavingsChart(savingsData) {
      if (reportSavingsChart) reportSavingsChart.destroy();

      reportSavingsChart = new Chart(reportSavingsChartCanvas.getContext('2d'), {
        type: 'line',
        data: {
          labels: monthNames,
          datasets: [
            {
              label: 'Savings (R)',
              data: savingsData,
              fill: true,
              backgroundColor: 'rgba(39, 174, 96, 0.3)', // Emerald green translucent
              borderColor: 'rgba(39, 174, 96, 1)',
              tension: 0.3,
              pointRadius: 5,
              pointHoverRadius: 7,
              borderWidth: 3,
            },
          ],
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: true },
            tooltip: {
              callbacks: {
                label: ctx => `R ${ctx.parsed.y.toFixed(2)}`,
              },
            },
          },
          scales: {
            y: {
              beginAtZero: true,
              ticks: {
                callback: val => `R${val}`,
              },
            },
          },
        },
      });
    }

    // Update report expenses chart
    let reportExpensesChart = null;
    function updateReportExpensesChart(expensesData) {
      if (reportExpensesChart) reportExpensesChart.destroy();

      let labels = [];
      let data = [];

      if (Array.isArray(expensesData)) {
        // Monthly data: object with categories
        labels = expenseCategories;
        data = expenseCategories.map(c => expensesData[c] || 0);
      } else {
        // Aggregated total expenses: object with keys
        labels = Object.keys(expensesData);
        data = Object.values(expensesData);
      }

      reportExpensesChart = new Chart(reportExpensesChartCanvas.getContext('2d'), {
        type: 'pie',
        data: {
          labels,
          datasets: [
            {
              data,
              backgroundColor: [
                '#FF6F61', // Sunset Orange
                '#6F42C1', // Electric Indigo
                '#F9E79F', // Pastel Yellow
                '#9B59B6', // Soft Purple
                '#27AE60', // Emerald Green
                '#FF9F1C',
                '#00B4D8',
                '#E36414',
                '#7E57C2',
              ],
            },
          ],
        },
        options: {
          responsive: true,
          plugins: {
            legend: { position: 'bottom' },
            tooltip: {
              callbacks: {
                label: ctx => `${ctx.label}: R ${ctx.parsed.toFixed(2)}`,
              },
            },
          },
        },
      });
    }

    // Clear report charts
    function clearReportCharts() {
      if (reportSavingsChart) reportSavingsChart.destroy();
      if (reportExpensesChart) reportExpensesChart.destroy();
      reportSavingsChartCanvas.getContext('2d').clearRect(0, 0, reportSavingsChartCanvas.width, reportSavingsChartCanvas.height);
      reportExpensesChartCanvas.getContext('2d').clearRect(0, 0, reportExpensesChartCanvas.width, reportExpensesChartCanvas.height);
    }

    // PDF report generation
    async function generatePDFReport() {
      const { jsPDF } = window.jspdf;
      const pdf = new jsPDF('p', 'pt', 'a4');
      const margin = 40;
      let y = margin;

      pdf.setFont('Poppins', 'bold');
      pdf.setFontSize(18);
      pdf.text('SmartCents Financial Report', margin, y);
      y += 30;

      pdf.setFontSize(12);
      const summaryLines = reportSummary.textContent.trim().split('\n').map(line => line.trim());
      summaryLines.forEach(line => {
        pdf.text(line, margin, y);
        y += 18;
      });
      y += 10;

      // Capture and add charts as images
      const savingsChartImg = await html2canvas(reportSavingsChartCanvas, { backgroundColor: '#fff', scale: 2 });
      const savingsChartDataURL = savingsChartImg.toDataURL('image/png');

      const expensesChartImg = await html2canvas(reportExpensesChartCanvas, { backgroundColor: '#fff', scale: 2 });
      const expensesChartDataURL = expensesChartImg.toDataURL('image/png');

      // Add savings chart
      pdf.text('Savings Progress Chart:', margin, y);
      y += 10;
      pdf.addImage(savingsChartDataURL, 'PNG', margin, y, pdf.internal.pageSize.getWidth() - margin * 2, 150);
      y += 160;

      // Check for page overflow
      if (y > pdf.internal.pageSize.getHeight() - margin - 160) {
        pdf.addPage();
        y = margin;
      }

      // Add expenses chart
      pdf.text('Expenses Breakdown Chart:', margin, y);
      y += 10;
      pdf.addImage(expensesChartDataURL, 'PNG', margin, y, pdf.internal.pageSize.getWidth() - margin * 2, 150);
      y += 160;

      pdf.save(`SmartCents_Report_${currentYear}_${reportType === 'month' ? monthNames[currentMonth] : ''}.pdf`);
    }

    // Tab navigation logic
    function switchTab(tab) {
      if (tab === 'budget') {
        tabBudgetBtn.classList.add('active');
        tabDocumentsBtn.classList.remove('active');
        tabBudgetContent.classList.add('active');
        tabDocumentsContent.classList.remove('active');
      } else {
        tabBudgetBtn.classList.remove('active');
        tabDocumentsBtn.classList.add('active');
        tabBudgetContent.classList.remove('active');
        tabDocumentsContent.classList.add('active');
        loadDocumentsVault();
      }
    }

    tabBudgetBtn.addEventListener('click', () => switchTab('budget'));
    tabDocumentsBtn.addEventListener('click', () => switchTab('documents'));

    // Initialize UI
    initYearMonthSelectors();
    createExpenseInputs();
    populateInputs();
    updateCharts();
    loadDocumentsVault();
  </script>

  <script
    src="https://kit.fontawesome.com/3e7749d6ec.js"
    crossorigin="anonymous"
  ></script>
</body>

</html>
